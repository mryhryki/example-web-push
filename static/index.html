<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>example-web-push</title>
  </head>
  <body style="width: 100vw; max-width: 800px; margin: 0 auto;">
    <h1 style="text-align: center;">
      <a href="https://github.com/mryhryki/example-web-push">
        mryhryki/example-web-push
      </a>
    </h1>

    <p style="text-align: center">
      <button id="subscribe-button" style="padding: 0.5rem 1rem; font-size: 1.5rem;">Subscribe</button>
    </p>

    <script>
      let registration = null;
      (async() => {
        if ("serviceWorker" in navigator) {
          registration = await navigator.serviceWorker.register("/service-worker.js")
          console.log("ServiceWorker registration successful with scope: ", registration.scope)
        } else {
          console.error("ServiceWorker not supported")
        }
      })()


      window.addEventListener("DOMContentLoaded", () => {
        if (!("Notification" in window)) {
          console.error("This browser does not support web push notification")
          return
        }

        document.getElementById("subscribe-button").addEventListener("click", async () => {
          if (registration == null) {
            console.error("ServiceWorker registration failed")
            return
          }
          const keyPair = await crypto.subtle.generateKey({
            name: 'ECDSA',
            namedCurve: 'P-256'
          }, false, ['sign', 'verify'])
          const publicKey = await crypto.subtle.exportKey('raw', keyPair.privateKey);
          console.debug('###', JSON.stringify({ publicKey}, null, 2))

          const permission = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: publicKey
          });
          console.log(permission)
          // https://developer.mozilla.org/docs/Web/API/Notification/Notification
          // new Notification("Permission granted", {
          //   body: "You can receive web push notification",
          //   icon: "https://example-web-push.deno.dev/icon.png",
          //   requireInteraction: true,
          //   tag: "permission-granted",
          //   vibrate: 500,
          // })
        })
      })
    </script>
  </body>
</html>
