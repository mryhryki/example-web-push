<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>example-web-push</title>
  </head>
  <body style="width: 100vw; max-width: 800px; margin: 0 auto;">
    <h1 style="text-align: center;">
      <a href="https://github.com/mryhryki/example-web-push">
        mryhryki/example-web-push
      </a>
    </h1>

    <p style="text-align: center">
      <button id="subscribe-button" style="padding: 0.5rem 1rem; font-size: 1.5rem;">Subscribe</button>
    </p>

    <p id="permission-endpoint" style="text-align: center; overflow-wrap: anywhere;"></p>
    <p style="text-align: center">
      <button id="publish-message" style="padding: 0.5rem 1rem; font-size: 1.5rem;">Publish Message</button>
    </p>


    <script type="module">
      let registration = null;
      (async() => {
        if ("serviceWorker" in navigator) {
          registration = await navigator.serviceWorker.register("/service-worker.js")
          console.log("ServiceWorker registration successful with scope: ", registration.scope)
        } else {
          console.error("ServiceWorker not supported")
        }
      })()

      window.addEventListener("DOMContentLoaded", () => {
        if (!("Notification" in window)) {
          console.error("This browser does not support web push notification")
          return
        }

        document.getElementById("subscribe-button").addEventListener("click", async () => {
          if (registration == null) {
            console.error("ServiceWorker registration failed")
            return
          }
          const publicKey = '[[PUBLIC-KEY]]';
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: false,
            applicationServerKey: publicKey
          });
          console.debug("Subscription:", subscription)
          const auth = subscription.getKey("auth");
          const p256dh = subscription.getKey("p256dh");
          console.log("Subscription.auth:", auth)
          console.log("Subscription.p256dh:", p256dh)

          document.getElementById("permission-endpoint").innerText = subscription.endpoint;

          // https://developer.mozilla.org/docs/Web/API/Notification/Notification
          // new Notification("Permission granted", {
          //   body: "You can receive web push notification",
          //   icon: "https://example-web-push.deno.dev/icon.png",
          //   requireInteraction: true,
          //   tag: "permission-granted",
          //   vibrate: 500,
          // })

          document.getElementById("publish-message").addEventListener("click", async () => {
            const response = await fetch("/publish-message", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                endpoint: subscription.endpoint,
                message: "Hello, world!"
              })
            })
            console.debug("Publish Response:", response)
            console.debug("Publish Response Body:", await response.text());
          })
        })
      })
    </script>
  </body>
</html>
